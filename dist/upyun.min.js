angular.module("upyun",[]).directive("upyunUpload",function(){function e(e,n,i,u){function t(e){return null!=e&&e.preventDefault(),e.dataTransfer.effectAllowed="copy",!1}function o(e){null!=e&&e.preventDefault(),r(e.dataTransfer.files)}function r(n){u.$setViewValue(n),e.$apply(),e.$eval(i.fileSelect)}e.$watch(function(){return u.$viewValue},function(e){e||n.val("")}),n.bind("dragover",t),n.bind("dragenter",t),n.bind("drop",o),n.bind("change",function(e){r(e.target.files)})}return{require:"ngModel",restrict:"A",link:e}}).service("upyunUploader",["$http","$log",function(e,n){"user strict";function i(e){return e.dir?e.bucket?e.apiSecret?(a.upyunConfigs.params["save-key"]=e.dir+"/{filemd5}{.suffix}",a.upyunConfigs.params.bucket=e.bucket,void(a.upyunConfigs.form_api_secret=e.apiSecret)):void n("no apiSecret specified in configs"):void n("no bucket specified in configs"):void n("no dir specified in configs")}function u(e){if(e){a.queue=[];for(var n=0;n<e.length;n++)a.queue.push(e[n])}}function t(){for(var e=0;e<a.queue.length&&!(a.activeUploads>=a.options.concurrency);e++)a.queue[e].active||r(a.queue[e])}function o(e){a.queue.splice(a.queue.indexOf(e),1)}function r(n){a.activeUploads+=1,n.active=!0;var i;i=new window.FormData,a.upyunConfigs.params.expiration=(new Date).getTime()+60;var u=Base64.encode(JSON.stringify(a.upyunConfigs.params)),r=SparkMD5.hash(u+"&"+a.upyunConfigs.form_api_secret),s="https://v0.api.upyun.com/"+a.upyunConfigs.params.bucket,c=a.upyunConfigs.params.bucket+".b0.upaiyun.com",p="https://"+c;i.append("file",n),i.append("policy",u),i.append("signature",r),e.post(s,i,{transformRequest:angular.identity,headers:{"Content-Type":void 0}}).success(function(e){a.activeUploads-=1,a.tasksNum-=1,o(n),t(),a.results.push(p+e.url),0==a.tasksNum&&(a.isBlocked=!1,a.success(a.results))}).error(function(){a.queue=[],a.tasksNum=0,a.isBlocked=!1,a.failed(new Error("upload failed"),a.results)})}function s(e,n,i){return a.isBlocked?void i(new Error("is blocked")):0==e.length?void i(new Error("no file")):(a.tasksNum=e.length,a.results=[],a.isBlocked=!0,u(e),a.success=n||function(){},a.failed=i||function(){},void t())}var a=this;return a.queue=[],a.results=[],a.isBlocked=!1,a.upyunConfigs={form_api_secret:"",params:{expiration:(new Date).getTime()+60,"save-key":"","allow-file-type":"jpg,jpeg,gif,png,pdf",bucket:""}},a.options={concurrency:3},a.activeUploads=0,{config:i,uploadFiles:s}}]);