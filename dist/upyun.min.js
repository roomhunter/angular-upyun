angular.module("upyun",[]).directive("fileSelect",function(){function e(e,i,n,t){i.bind("change",function(i){t.$setViewValue(i.target.files),e.$apply()}),e.$watch(function(){return t.$viewValue},function(e){e||i.val("")})}return{require:"ngModel",restrict:"A",scope:{fileSelect:"="},link:e}}).service("upyunUploader",["$http","$log",function(e,i){"user strict";function n(e){return e.dir?e.bucket?e.apiSecret?(r.upyunConfigs.params["save-key"]=e.dir+"/{filemd5}{.suffix}",r.upyunConfigs.params.bucket=e.bucket,void(r.upyunConfigs.form_api_secret=e.apiSecret)):void i("no apiSecret specified in configs"):void i("no bucket specified in configs"):void i("no dir specified in configs")}function t(e){r.options.success=e||function(){}}function o(e){r.options.faild=e||function(){}}function s(e){if(e)for(var i=0;i<e.length;i++)r.files.push(e[i])}function c(){for(var e=0;e<r.files.length&&r.activeUploads!=r.options.concurrency;e++)r.files[e].active||a(r.files[e])}function u(e){r.files.splice(r.files.indexOf(e),1)}function a(i){r.activeUploads+=1,i.active=!0;var n;n=new window.FormData,r.upyunConfigs.params.expiration=(new Date).getTime()+60;var t=Base64.encode(JSON.stringify(r.upyunConfigs.params)),o=SparkMD5.hash(t+"&"+r.upyunConfigs.form_api_secret),s="http://v0.api.upyun.com/"+r.upyunConfigs.params.bucket,c="http://"+r.upyunConfigs.params.bucket+".b0.upaiyun.com";n.append("file",i),n.append("policy",t),n.append("signature",o),e.post(s,n,{transformRequest:angular.identity,headers:{"Content-Type":void 0}}).success(function(e){r.activeUploads-=1,u(i),r.options.success(c+e.url)}).error(function(){r.options.failed()})}var r=this;return r.files=[],r.upyunConfigs={form_api_secret:"",params:{expiration:(new Date).getTime()+60,"save-key":"","allow-file-type":"jpg,jpeg,gif,png",bucket:""}},r.options={concurrency:2,success:function(){},failed:function(){}},r.activeUploads=0,{addFiles:s,config:n,startUpload:c,onSuccess:t,onError:o}}]);