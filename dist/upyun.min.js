angular.module("upyun",[]).directive("upyunUpload",function(){function e(e,n,i,t){function o(e){return null!=e&&e.preventDefault(),e.dataTransfer.effectAllowed="copy",!1}function u(e){null!=e&&e.preventDefault(),a(e.dataTransfer.files)}function a(n){t.$setViewValue(n),e.$apply(),e.$eval(i.fileSelect)}e.$watch(function(){return t.$viewValue},function(e){e||n.val("")}),n.bind("dragover",o),n.bind("dragenter",o),n.bind("drop",u),n.bind("change",function(e){a(e.target.files)})}return{require:"ngModel",restrict:"A",link:e}}).service("upyunUploader",["$http","$log",function(e,n){"user strict";function i(e){return e.dir?e.bucket?e.apiSecret?(c.upyunConfigs.params["save-key"]=e.dir+"/{filemd5}{.suffix}",c.upyunConfigs.params.bucket=e.bucket,void(c.upyunConfigs.form_api_secret=e.apiSecret)):void n("no apiSecret specified in configs"):void n("no bucket specified in configs"):void n("no dir specified in configs")}function t(e){c.options.success=e||function(){}}function o(e){c.options.faild=e||function(){}}function u(e){if(e)for(var n=0;n<e.length;n++)c.files.push(e[n])}function a(){for(var e=0;e<c.files.length&&!(c.activeUploads>=c.options.concurrency);e++)c.files[e].active||r(c.files[e])}function s(e){c.files.splice(c.files.indexOf(e),1)}function r(n){c.activeUploads+=1,n.active=!0;var i;i=new window.FormData,c.upyunConfigs.params.expiration=(new Date).getTime()+60;var t=Base64.encode(JSON.stringify(c.upyunConfigs.params)),o=SparkMD5.hash(t+"&"+c.upyunConfigs.form_api_secret),u="https://v0.api.upyun.com/"+c.upyunConfigs.params.bucket,a=c.upyunConfigs.params.bucket+".b0.upaiyun.com",r="http://"+a,f="https://"+a;i.append("file",n),i.append("policy",t),i.append("signature",o),e.post(u,i,{transformRequest:angular.identity,headers:{"Content-Type":void 0}}).success(function(e){c.activeUploads-=1,s(n),c.options.success(f+e.url,r+e.url)}).error(function(){c.options.failed()})}var c=this;return c.files=[],c.upyunConfigs={form_api_secret:"",params:{expiration:(new Date).getTime()+60,"save-key":"","allow-file-type":"jpg,jpeg,gif,png,pdf",bucket:""}},c.options={concurrency:3,success:function(){},failed:function(){}},c.activeUploads=0,{setFiles:u,config:i,startUpload:a,onSuccess:t,onError:o}}]);