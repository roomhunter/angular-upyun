angular.module("upyun",[]).directive("upyunUpload",function(){function e(e,n,i,u){function t(e){return null!=e&&e.preventDefault(),e.dataTransfer.effectAllowed="copy",!1}function o(e){null!=e&&e.preventDefault(),r(e.dataTransfer.files)}function r(n){u.$setViewValue(n),e.$apply(),e.$eval(i.fileSelect)}e.$watch(function(){return u.$viewValue},function(e){e||n.val("")}),n.bind("dragover",t),n.bind("dragenter",t),n.bind("drop",o),n.bind("change",function(e){r(e.target.files)})}return{require:"ngModel",restrict:"A",link:e}}).service("upyunUploader",["$http","$log",function(e,n){"user strict";function i(e){return e.dir?e.bucket?e.apiSecret?(s.upyunConfigs.params["save-key"]=e.dir+"/{filemd5}{.suffix}",s.upyunConfigs.params.bucket=e.bucket,void(s.upyunConfigs.form_api_secret=e.apiSecret)):void n("no apiSecret specified in configs"):void n("no bucket specified in configs"):void n("no dir specified in configs")}function u(e){if(e){s.queue=[];for(var n=0;n<e.length;n++)s.queue.push(e[n])}}function t(){for(var e=0;e<s.queue.length&&!(s.activeUploads>=s.options.concurrency);e++)s.queue[e].active||r(s.queue[e])}function o(e){s.queue.splice(s.queue.indexOf(e),1)}function r(n){s.activeUploads+=1,n.active=!0;var i;i=new window.FormData,s.upyunConfigs.params.expiration=(new Date).getTime()+60;var u=Base64.encode(JSON.stringify(s.upyunConfigs.params)),r=SparkMD5.hash(u+"&"+s.upyunConfigs.form_api_secret),a="https://v0.api.upyun.com/"+s.upyunConfigs.params.bucket,c=s.upyunConfigs.params.bucket+".b0.upaiyun.com",p="https://"+c;i.append("file",n),i.append("policy",u),i.append("signature",r),i.append("x-gmkerl-rotate","auto"),e.post(a,i,{transformRequest:angular.identity,headers:{"Content-Type":void 0}}).success(function(e){s.activeUploads-=1,s.tasksNum-=1,o(n),t(),s.results.push(p+e.url),0==s.tasksNum&&(s.isBlocked=!1,s.success(s.results))}).error(function(){s.queue=[],s.tasksNum=0,s.isBlocked=!1,s.failed(new Error("upload failed"),s.results)})}function a(e,n,i){return s.isBlocked?void i(new Error("is blocked")):0==e.length?void i(new Error("no file")):(s.tasksNum=e.length,s.results=[],s.isBlocked=!0,u(e),s.success=n||function(){},s.failed=i||function(){},void t())}var s=this;return s.queue=[],s.results=[],s.isBlocked=!1,s.upyunConfigs={form_api_secret:"",params:{expiration:(new Date).getTime()+60,"save-key":"","allow-file-type":"jpg,jpeg,gif,png,pdf",bucket:""}},s.options={concurrency:3},s.activeUploads=0,{config:i,uploadFiles:a}}]);