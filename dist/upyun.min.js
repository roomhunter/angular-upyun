angular.module("upyun",[]).directive("upyunUpload",function(){function e(e,i,n,u){function t(e){return null!=e&&e.preventDefault(),e.dataTransfer.effectAllowed="copy",!1}function r(e){null!=e&&e.preventDefault(),o(e.dataTransfer.files)}function o(i){u.$setViewValue(i),e.$apply(),e.$eval(n.fileSelect)}e.$watch(function(){return u.$viewValue},function(e){e||i.val("")}),i.bind("dragover",t),i.bind("dragenter",t),i.bind("drop",r),i.bind("change",function(e){o(e.target.files)})}return{require:"ngModel",restrict:"A",link:e}}).service("upyunUploader",["$http","$log",function(e,i){"user strict";function n(e){return e.dir?e.bucket?e.apiSecret?(s.upyunConfigs.params["save-key"]=e.dir+"/{filemd5}{.suffix}",s.upyunConfigs.params.bucket=e.bucket,void(s.upyunConfigs.form_api_secret=e.apiSecret)):void i("no apiSecret specified in configs"):void i("no bucket specified in configs"):void i("no dir specified in configs")}function u(e){if(e){s.queue=[];for(var i=0;i<e.length;i++){if(p.indexOf(e[i].type)<0)return s.isBlocked=!1,void s.failed(new TypeError("mime types error"),void 0);s.queue.push(e[i])}}}function t(){for(var e=0;e<s.queue.length&&!(s.activeUploads>=s.options.concurrency);e++)s.queue[e].active||o(s.queue[e])}function r(e){s.queue.splice(s.queue.indexOf(e),1)}function o(i){s.activeUploads+=1,i.active=!0;var n;n=new window.FormData,s.upyunConfigs.params.expiration=(new Date).getTime()+60;var u=Base64.encode(JSON.stringify(s.upyunConfigs.params)),o=SparkMD5.hash(u+"&"+s.upyunConfigs.form_api_secret),a="https://v0.api.upyun.com/"+s.upyunConfigs.params.bucket,p=s.upyunConfigs.params.bucket+".b0.upaiyun.com",c="https://"+p;n.append("file",i),n.append("policy",u),n.append("signature",o),n.append("x-gmkerl-rotate","auto"),e.post(a,n,{transformRequest:angular.identity,headers:{"Content-Type":void 0}}).success(function(e){s.activeUploads-=1,s.tasksNum-=1,r(i),t(),s.results.push(c+e.url),0==s.tasksNum&&(s.isBlocked=!1,s.success(s.results))}).error(function(){s.queue=[],s.tasksNum=0,s.isBlocked=!1,s.failed(new Error("upload failed"),s.results)})}function a(e,i,n){return s.isBlocked?void n(new Error("is blocked")):0==e.length?void n(new Error("no file")):(s.tasksNum=e.length,s.results=[],s.isBlocked=!0,s.success=i||function(){},s.failed=n||function(){},u(e),void t())}var s=this,p=["application/pdf","image/jpg","image/jpeg","image/gif","image/png"];return s.queue=[],s.results=[],s.isBlocked=!1,s.upyunConfigs={form_api_secret:"",params:{expiration:(new Date).getTime()+60,"save-key":"","allow-file-type":"jpg,jpeg,gif,png,pdf",bucket:""}},s.options={concurrency:3},s.activeUploads=0,{config:n,uploadFiles:a}}]);